{
  "openapi": "3.0.3",
  "info": {
    "title": "Telco ADB Automation API",
    "description": "REST API for managing devices, flows, and executions in the Telco ADB Automation Desktop Framework",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "http://localhost:8000/api/v1",
      "description": "Local development server"
    }
  ],
  "paths": {
    "/devices": {
      "get": {
        "summary": "List connected devices",
        "description": "Retrieve all currently connected Android devices with their metadata",
        "responses": {
          "200": {
            "description": "List of connected devices",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Device" }
                }
              }
            }
          }
        }
      }
    },
    "/devices/{device_id}": {
      "get": {
        "summary": "Get device details",
        "parameters": [
          {
            "name": "device_id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Device details",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Device" }
              }
            }
          },
          "404": {
            "description": "Device not found"
          }
        }
      }
    },
    "/modules": {
      "get": {
        "summary": "List available modules",
        "parameters": [
          {
            "name": "category",
            "in": "query",
            "schema": { "type": "string" }
          },
          {
            "name": "active_only",
            "in": "query",
            "schema": { "type": "boolean", "default": true }
          }
        ],
        "responses": {
          "200": {
            "description": "List of available modules",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Module" }
                }
              }
            }
          }
        }
      }
    },
    "/flows": {
      "get": {
        "summary": "List flows",
        "parameters": [
          {
            "name": "visibility",
            "in": "query",
            "schema": { "type": "string", "enum": ["private", "shared", "public"] }
          }
        ],
        "responses": {
          "200": {
            "description": "List of flows",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Flow" }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Create new flow",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/FlowCreate" }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Flow created successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Flow" }
              }
            }
          },
          "400": {
            "description": "Invalid flow definition"
          }
        }
      }
    },
    "/flows/{flow_id}/execute": {
      "post": {
        "summary": "Execute flow on selected devices",
        "parameters": [
          {
            "name": "flow_id",
            "in": "path",
            "required": true,
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/ExecutionRequest" }
            }
          }
        },
        "responses": {
          "202": {
            "description": "Execution started",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Execution" }
              }
            }
          },
          "400": {
            "description": "Invalid execution request"
          },
          "404": {
            "description": "Flow not found"
          }
        }
      }
    },
    "/executions": {
      "get": {
        "summary": "List executions",
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "schema": { "type": "string", "enum": ["pending", "running", "completed", "failed", "cancelled"] }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": { "type": "integer", "default": 50 }
          }
        ],
        "responses": {
          "200": {
            "description": "List of executions",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Execution" }
                }
              }
            }
          }
        }
      }
    },
    "/executions/{execution_id}": {
      "get": {
        "summary": "Get execution details",
        "parameters": [
          {
            "name": "execution_id",
            "in": "path",
            "required": true,
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "responses": {
          "200": {
            "description": "Execution details with steps",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ExecutionDetail" }
              }
            }
          },
          "404": {
            "description": "Execution not found"
          }
        }
      }
    },
    "/executions/{execution_id}/cancel": {
      "post": {
        "summary": "Cancel running execution",
        "parameters": [
          {
            "name": "execution_id",
            "in": "path",
            "required": true,
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "responses": {
          "200": {
            "description": "Execution cancelled"
          },
          "400": {
            "description": "Cannot cancel execution in current state"
          }
        }
      }
    },
    "/reports/{execution_id}": {
      "get": {
        "summary": "Download execution report",
        "parameters": [
          {
            "name": "execution_id",
            "in": "path",
            "required": true,
            "schema": { "type": "string", "format": "uuid" }
          },
          {
            "name": "format",
            "in": "query",
            "schema": { "type": "string", "enum": ["pdf", "csv", "html"], "default": "pdf" }
          }
        ],
        "responses": {
          "200": {
            "description": "Report file",
            "content": {
              "application/pdf": {},
              "text/csv": {},
              "text/html": {}
            }
          },
          "404": {
            "description": "Report not found"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "Device": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "phone_number": { "type": "string", "nullable": true },
          "sim_info": { "type": "object" },
          "model": { "type": "string" },
          "os_version": { "type": "string" },
          "status": { "type": "string", "enum": ["connected", "disconnected", "busy", "error"] },
          "last_seen": { "type": "string", "format": "date-time" },
          "capabilities": { "type": "object" }
        }
      },
      "Module": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "description": { "type": "string" },
          "version": { "type": "string" },
          "category": { "type": "string" },
          "steps": { "type": "array", "items": { "type": "string" } },
          "input_schema": { "type": "object" },
          "timeout_seconds": { "type": "integer" },
          "requires_root": { "type": "boolean" }
        }
      },
      "Flow": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "name": { "type": "string" },
          "description": { "type": "string", "nullable": true },
          "visibility": { "type": "string", "enum": ["private", "shared", "public"] },
          "modules": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/FlowModule" }
          },
          "estimated_duration_minutes": { "type": "integer", "nullable": true },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "FlowModule": {
        "type": "object",
        "properties": {
          "module_id": { "type": "string" },
          "sequence_order": { "type": "integer" },
          "input_parameters": { "type": "object" },
          "continue_on_failure": { "type": "boolean" },
          "retry_count": { "type": "integer" }
        }
      },
      "FlowCreate": {
        "type": "object",
        "required": ["name", "modules"],
        "properties": {
          "name": { "type": "string" },
          "description": { "type": "string" },
          "visibility": { "type": "string", "enum": ["private", "shared", "public"], "default": "private" },
          "modules": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/FlowModule" }
          }
        }
      },
      "ExecutionRequest": {
        "type": "object",
        "required": ["device_ids"],
        "properties": {
          "device_ids": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      },
      "Execution": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "flow_id": { "type": "string", "format": "uuid" },
          "status": { "type": "string", "enum": ["pending", "running", "completed", "failed", "cancelled"] },
          "start_time": { "type": "string", "format": "date-time", "nullable": true },
          "end_time": { "type": "string", "format": "date-time", "nullable": true },
          "progress_percentage": { "type": "integer" },
          "current_step": { "type": "string", "nullable": true },
          "devices": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/ExecutionDevice" }
          }
        }
      },
      "ExecutionDevice": {
        "type": "object",
        "properties": {
          "device_id": { "type": "string" },
          "status": { "type": "string", "enum": ["assigned", "running", "completed", "failed"] },
          "start_time": { "type": "string", "format": "date-time", "nullable": true },
          "end_time": { "type": "string", "format": "date-time", "nullable": true },
          "error_message": { "type": "string", "nullable": true }
        }
      },
      "ExecutionDetail": {
        "allOf": [
          { "$ref": "#/components/schemas/Execution" },
          {
            "type": "object",
            "properties": {
              "steps": {
                "type": "array",
                "items": { "$ref": "#/components/schemas/ExecutionStep" }
              }
            }
          }
        ]
      },
      "ExecutionStep": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "module_id": { "type": "string" },
          "device_id": { "type": "string" },
          "step_index": { "type": "integer" },
          "status": { "type": "string", "enum": ["pending", "running", "completed", "failed", "skipped"] },
          "start_time": { "type": "string", "format": "date-time", "nullable": true },
          "end_time": { "type": "string", "format": "date-time", "nullable": true },
          "output_data": { "type": "object", "nullable": true },
          "error_code": { "type": "string", "nullable": true },
          "screenshot_path": { "type": "string", "nullable": true }
        }
      }
    }
  }
}